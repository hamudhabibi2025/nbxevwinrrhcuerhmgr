<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASKAB PSSI KEPULAUAN MENTAWAI</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Styling kustom untuk header */
        .app-header {
            background-color: #1e3a8a; /* Biru gelap PSSI */
            color: white;
            padding: 0.5rem 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        /* Styling kustom untuk navigasi bawah */
        .app-nav {
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.05);
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 50;
        }

        .nav-item {
            color: #9ca3af; /* Abu-abu default */
            transition: color 0.15s;
        }

        .nav-item.active {
            color: #1e3a8a; /* Biru PSSI aktif */
            font-weight: 600;
        }

        /* Custom scrollbar for better appearance */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animation for banner */
        .banner-slide {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        /* Style untuk modal/notifikasi */
        .modal-overlay, .notification {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.show, .notification.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-box, .notification-box {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            transform: translateY(-50px);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-box, .notification.show .notification-box {
            transform: translateY(0);
        }
        /* Notifikasi posisi sepertiga atas tengah */
        .notification {
            align-items: flex-start;
            top: 33.33vh; /* Sepertiga atas */
            height: auto;
            pointer-events: none;
        }
        .notification-box {
            transform: none;
            max-width: 400px;
            padding: 1rem;
            animation: fadeInOut 3s forwards;
            pointer-events: auto;
        }

        /* Animation untuk notifikasi melayang */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .loading-overlay.show {
            display: flex;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #1e3a8a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="notification">
        <div id="notification-box" class="notification-box bg-white p-4 rounded-lg shadow-xl text-sm transition-all duration-300">
            <!-- Content notifikasi akan diisi di sini -->
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-box w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-gray-800" id="confirm-title">Konfirmasi</h3>
            <p class="mt-2 text-sm text-gray-600" id="confirm-message">Apakah Anda yakin?</p>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Batal</button>
                <button id="confirm-ok" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="app-container" class="pb-20">
        <!-- Konten Aplikasi akan dimuat di sini (Login / Dashboard) -->
    </div>

    <!-- Navigasi Bawah (Hanya muncul saat login) -->
    <div id="main-nav" class="app-nav hidden">
        <div class="max-w-xl mx-auto flex justify-around h-16">
            <!-- Nav Home -->
            <button class="nav-item flex flex-col items-center justify-center p-2" onclick="changePage('home')">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="text-xs">Home</span>
            </button>
            <!-- Nav Pemain -->
            <button class="nav-item flex flex-col items-center justify-center p-2" onclick="changePage('pemain')">
                <i data-lucide="footballs" class="w-5 h-5"></i>
                <span class="text-xs">Pemain</span>
            </button>
            <!-- Nav Official -->
            <button class="nav-item flex flex-col items-center justify-center p-2" onclick="changePage('official')">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="text-xs">Official</span>
            </button>
            <!-- Nav Kompetisi -->
            <button class="nav-item flex flex-col items-center justify-center p-2" onclick="changePage('kompetisi')">
                <i data-lucide="trophy" class="w-5 h-5"></i>
                <span class="text-xs">Kompetisi</span>
            </button>
            <!-- Nav Setting -->
            <button class="nav-item flex flex-col items-center justify-center p-2" onclick="changePage('setting')">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="text-xs">Setting</span>
            </button>
        </div>
    </div>

    <script>
        // *** Konfigurasi dan Variabel Global ***
        const API_URL = "https://script.google.com/macros/s/AKfycbxgPR6aLTaALmwbCd-8OQIkPD3x5SOm4k8-OI3da9ftVaVwhghCakwLM8bEpLJu9tvqfA/exec"; // Ganti dengan URL Apps Script Anda
        const ORG_NAME = "ASKAB PSSI KEPULAUAN MENTAWAI";
        const LOGO_PSSI = "https://i.ibb.co.com/M5VpK1wG/images.png";
        const LOGO_ASKAB = "https://i.ibb.co.com/M5VpK1wG/images.png";
        const IMGBB_API_KEY = "e9c06944a26b81e611e960c10a31634f"; // Digunakan hanya di frontend jika ingin upload langsung, tapi kita pakai backend Apps Script.

        let CURRENT_USER = null;
        let CURRENT_PAGE = 'home';
        let PROFILE_KLUB_DATA = [];
        let PEMAIN_DATA = [];
        let OFFICIAL_DATA = [];
        let KOMPETISI_DATA = [];
        let SETTING_DATA = {};
        let COMBOBOX_PLAYER_LIST = [];
        let COMBOBOX_OFFICIAL_LIST = [];
        let BANNER_DATA = {};

        // *** UTILITY & UI FUNCTIONS ***

        /**
         * Menampilkan/menyembunyikan loading overlay.
         * @param {boolean} show True untuk menampilkan, False untuk menyembunyikan.
         */
        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('show', show);
        }

        /**
         * Menampilkan notifikasi melayang.
         * @param {string} message Pesan notifikasi.
         * @param {string} type Tipe notifikasi ('success', 'error', 'info').
         */
        function showNotification(message, type = 'info') {
            const modal = document.getElementById('notification-modal');
            const box = document.getElementById('notification-box');

            let bgColor = 'bg-blue-500';
            let icon = '<i data-lucide="info" class="w-5 h-5 mr-2"></i>';

            if (type === 'success') {
                bgColor = 'bg-green-500';
                icon = '<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = '<i data-lucide="x-octagon" class="w-5 h-5 mr-2"></i>';
            }

            box.innerHTML = `
                <div class="flex items-center text-white ${bgColor} p-3 rounded-lg shadow-xl">
                    ${icon}
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            modal.classList.add('show');
            lucide.createIcons(); // Re-render icons

            setTimeout(() => {
                modal.classList.remove('show');
            }, 3000);
        }

        /**
         * Menampilkan modal konfirmasi.
         * @param {string} message Pesan konfirmasi.
         * @param {string} title Judul konfirmasi.
         * @returns {Promise<boolean>} Resolve true jika OK, false jika Batal.
         */
        function showConfirmation(message, title = 'Konfirmasi Tindakan') {
            return new Promise(resolve => {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('confirm-title').innerText = title;
                document.getElementById('confirm-message').innerText = message;

                const okButton = document.getElementById('confirm-ok');
                const cancelButton = document.getElementById('confirm-cancel');

                const handleOk = () => {
                    modal.classList.remove('show');
                    okButton.removeEventListener('click', handleOk);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.remove('show');
                    okButton.removeEventListener('click', handleOk);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                okButton.onclick = null; // Hapus listener lama
                cancelButton.onclick = null; // Hapus listener lama

                okButton.addEventListener('click', handleOk);
                cancelButton.addEventListener('click', handleCancel);

                modal.classList.add('show');
            });
        }

        /**
         * Fungsi wrapper untuk fetch API dengan penanganan error, loading, dan sesi.
         * Menerapkan exponential backoff untuk retry.
         * @param {string} action Aksi API.
         * @param {string} method HTTP method ('GET' atau 'POST').
         * @param {Object} data Body data untuk POST.
         * @param {number} maxRetries Jumlah maksimal retry.
         * @returns {Promise<Object>} Data response.
         */
        async function apiFetch(action, method = 'GET', data = null, maxRetries = 3) {
            showLoading(true);
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            if (CURRENT_USER && CURRENT_USER.sessionId) {
                url.searchParams.append('sessionId', CURRENT_USER.sessionId);
            }

            const fetchOptions = {
                method: method,
                headers: { 'Content-Type': 'application/json' },
            };

            if (method === 'POST' && data) {
                fetchOptions.body = JSON.stringify(data);
            } else if (method === 'GET' && data) {
                // Tambahkan data ke URL parameters untuk GET
                Object.keys(data).forEach(key => url.searchParams.append(key, data[key]));
            }

            for (let retry = 0; retry < maxRetries; retry++) {
                try {
                    const response = await fetch(url.toString(), fetchOptions);
                    const result = await response.json();

                    if (result.status === 'success') {
                        showLoading(false);
                        return result;
                    } else if (result.status === 'error' && result.message.includes('Sesi tidak valid')) {
                        // Handle sesi habis/invalid
                        CURRENT_USER = null;
                        renderLoginPage();
                        showNotification('Sesi telah berakhir. Silakan login kembali.', 'error');
                        showLoading(false);
                        return null; // Stop further execution
                    } else {
                        // Tampilkan error dari backend
                        showLoading(false);
                        showNotification(result.message || 'Terjadi kesalahan pada server.', 'error');
                        throw new Error(result.message);
                    }
                } catch (error) {
                    if (retry < maxRetries - 1) {
                        const delay = Math.pow(2, retry) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        showLoading(false);
                        showNotification('Koneksi gagal atau server tidak merespons.', 'error');
                        throw error;
                    }
                }
            }
        }

        /**
         * Mengkonversi file gambar (dari input file) ke Base64.
         * @param {File} file Objek file.
         * @returns {Promise<string>} String base64.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // *** AUTENTIKASI DAN SESSIONS ***

        /**
         * Mengecek status sesi saat aplikasi dimuat.
         */
        async function checkSessionStatus() {
            showLoading(true);
            const storedSessionId = localStorage.getItem('sessionId');

            if (!storedSessionId) {
                renderLoginPage();
                showLoading(false);
                return;
            }

            const url = new URL(API_URL);
            url.searchParams.append('action', 'checkSession');
            url.searchParams.append('sessionId', storedSessionId);

            try {
                const response = await fetch(url.toString());
                const result = await response.json();

                if (result.status === 'success' && result.data.isLoggedIn) {
                    CURRENT_USER = result.data.user;
                    localStorage.setItem('sessionId', CURRENT_USER.sessionId);
                    await initializeDashboard();
                } else {
                    localStorage.removeItem('sessionId');
                    renderLoginPage();
                }
            } catch (error) {
                console.error("Error checking session:", error);
                localStorage.removeItem('sessionId');
                renderLoginPage();
            } finally {
                showLoading(false);
            }
        }

        /**
         * Menangani proses login.
         */
        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showNotification('Semua field harus diisi.', 'error');
                return;
            }

            const result = await apiFetch('login', 'POST', { username, password });

            if (result && result.status === 'success') {
                CURRENT_USER = result.data.user;
                localStorage.setItem('sessionId', CURRENT_USER.sessionId);
                showNotification(`Selamat datang, ${CURRENT_USER.nama_admin}!`, 'success');
                await initializeDashboard();
            }
            // Error sudah ditangani di apiFetch
        }

        /**
         * Menangani proses logout.
         */
        async function handleLogout() {
            const confirmation = await showConfirmation('Anda yakin ingin keluar dari akun ini?');
            if (!confirmation) return;

            const sessionId = localStorage.getItem('sessionId');
            if (sessionId) {
                await apiFetch('logout', 'POST', null, 1); // 1 retry untuk logout
                localStorage.removeItem('sessionId');
            }
            CURRENT_USER = null;
            renderLoginPage();
            showNotification('Anda telah berhasil logout.', 'info');
        }

        // *** NAVIGATION & CORE APP ***

        /**
         * Memuat data inisial dan merender dashboard.
         */
        async function initializeDashboard() {
            showLoading(true);
            try {
                // Fetch data umum
                const bannerResult = await apiFetch('getBanners', 'GET', null);
                if (bannerResult) BANNER_DATA = bannerResult.data;

                // Set navigasi bawah
                const nav = document.getElementById('main-nav');
                nav.classList.remove('hidden');

                // Hilangkan navigasi Setting jika bukan ADMIN_PUSAT
                const settingButton = nav.querySelector('[onclick="changePage(\'setting\')"]');
                if (settingButton) {
                    settingButton.classList.toggle('hidden', CURRENT_USER.type_users !== 'ADMIN_PUSAT');
                }
                
                // Pindah ke halaman default (home)
                await changePage('home', true);

            } catch (error) {
                console.error("Error initializing dashboard:", error);
                showNotification('Gagal memuat data awal.', 'error');
                handleLogout(); // Paksa logout jika ada error fatal
            } finally {
                showLoading(false);
            }
        }

        /**
         * Merender halaman yang diminta.
         * @param {string} page Nama halaman.
         * @param {boolean} isInitial Apakah ini pemuatan awal.
         */
        async function changePage(page, isInitial = false) {
            if (!isInitial && CURRENT_PAGE === page) return; // Jangan refresh jika di halaman yang sama

            CURRENT_PAGE = page;
            const container = document.getElementById('app-container');
            const navItems = document.querySelectorAll('.nav-item');

            // Update status aktif navigasi
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick').includes(`'${page}'`)) {
                    item.classList.add('active');
                }
            });
            lucide.createIcons(); // Update ikon untuk Nav

            // Render halaman
            showLoading(true);
            try {
                switch (page) {
                    case 'home':
                        container.innerHTML = await renderHomePage();
                        startBannerSlider();
                        break;
                    case 'pemain':
                        container.innerHTML = await renderPemainPage();
                        break;
                    case 'official':
                        container.innerHTML = await renderOfficialPage();
                        break;
                    case 'kompetisi':
                        container.innerHTML = await renderKompetisiPage();
                        break;
                    case 'setting':
                        if (CURRENT_USER.type_users === 'ADMIN_PUSAT') {
                            container.innerHTML = await renderSettingPage();
                        } else {
                            container.innerHTML = renderAccessDenied();
                        }
                        break;
                    case 'detailKompetisi':
                        // Akan ditangani oleh fungsi renderDetailKompetisi
                        break;
                    default:
                        container.innerHTML = renderNotFoundPage();
                }
            } catch (error) {
                console.error(`Error rendering ${page} page:`, error);
                container.innerHTML = `<div class="p-6 text-center text-red-600">Gagal memuat halaman. ${error.message}</div>`;
            } finally {
                showLoading(false);
            }

            // Atur History API untuk tombol kembali
            if (!isInitial) {
                history.pushState({ page: page }, page, `#${page}`);
            }
        }

        // Handle tombol kembali perangkat
        window.onpopstate = async function(event) {
            const page = event.state && event.state.page ? event.state.page : 'home';
            await changePage(page, true);
        };

        // *** RENDER PAGES ***

        function renderLoginPage() {
            const container = document.getElementById('app-container');
            document.getElementById('main-nav').classList.add('hidden');
            container.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
                        <div class="text-center mb-6">
                            <img src="${LOGO_PSSI}" alt="Logo PSSI" class="w-16 h-16 mx-auto mb-3">
                            <h1 class="text-2xl font-bold text-gray-800">${ORG_NAME}</h1>
                            <p class="text-gray-500 text-sm">Sistem Manajemen Klub</p>
                        </div>
                        <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                            <div class="mb-4">
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-700 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-800 transition-colors shadow-lg">
                                <i data-lucide="log-in" class="w-5 h-5 inline mr-2"></i> LOGIN
                            </button>
                        </form>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Merender Header Aplikasi.
         * @param {string} title Judul halaman.
         */
        function renderHeader(title) {
            return `
                <div class="app-header flex items-center justify-between">
                    <img src="${LOGO_PSSI}" alt="Logo PSSI" class="w-8 h-8 object-contain">
                    <h2 class="text-sm md:text-lg font-bold text-center flex-1 mx-2">${ORG_NAME}</h2>
                    <img src="${LOGO_ASKAB}" alt="Logo ASKAB" class="w-8 h-8 object-contain">
                </div>
                <div class="bg-white p-3 shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800">${title}</h3>
                </div>
            `;
        }

        // --- HOME PAGE ---

        /**
         * Merender Halaman Home (Banner + Profil Klub).
         */
        async function renderHomePage() {
            // Fetch Profil Klub Data
            const result = await apiFetch('getProfileKlub', 'GET');
            PROFILE_KLUB_DATA = result.data || [];

            let profileCard;
            const userProfile = PROFILE_KLUB_DATA.find(p => p.id_klub === CURRENT_USER.id_klub);
            
            if (CURRENT_USER.type_users === 'ADMIN_KLUB' && !userProfile) {
                // ADMIN_KLUB belum punya profil
                profileCard = renderFormProfileKlub(null);
            } else if (CURRENT_USER.type_users === 'ADMIN_KLUB' && userProfile) {
                // ADMIN_KLUB sudah punya profil
                profileCard = renderDetailProfileKlub(userProfile);
            } else if (CURRENT_USER.type_users === 'ADMIN_PUSAT') {
                // ADMIN_PUSAT (atau ADMIN_MEDIA) melihat daftar profil
                profileCard = renderListProfileKlub(PROFILE_KLUB_DATA);
            } else if (CURRENT_USER.type_users === 'ADMIN_MEDIA') {
                // ADMIN_MEDIA melihat daftar profil
                profileCard = renderListProfileKlub(PROFILE_KLUB_DATA);
            } else {
                 // Kasus default jika ada klub lain yang dilihat (misal di ADMIN_PUSAT/MEDIA)
                profileCard = renderListProfileKlub(PROFILE_KLUB_DATA);
            }


            return `
                ${renderHeader('Beranda & Profil Klub')}
                <div class="max-w-xl mx-auto p-4 space-y-6">
                    ${renderBannerSlider()}
                    <div class="bg-white p-4 rounded-xl shadow-lg">
                        <h4 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">Profil Klub Anda</h4>
                        <div id="profile-club-container">
                            ${profileCard}
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="w-full bg-red-600 text-white py-2.5 rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-lg mt-6">
                        <i data-lucide="log-out" class="w-5 h-5 inline mr-2"></i> LOGOUT
                    </button>
                </div>
            `;
        }

        // Sub-render untuk Home Page (Banner)
        function renderBannerSlider() {
            const urls = [BANNER_DATA.url_banner1, BANNER_DATA.url_banner2, BANNER_DATA.url_banner3].filter(url => url);
            if (urls.length === 0) {
                return '<div class="h-40 bg-gray-300 rounded-xl flex items-center justify-center text-gray-600">Tidak ada banner yang tersedia.</div>';
            }
            return `
                <div class="relative overflow-hidden rounded-xl shadow-lg h-48 md:h-64">
                    <div id="banner-slide-track" class="banner-slide h-full" style="width: ${urls.length * 100}%;">
                        ${urls.map(url => `
                            <div class="w-full flex-shrink-0 h-full">
                                <img src="${url}" alt="Banner" class="w-full h-full object-cover">
                            </div>
                        `).join('')}
                    </div>
                    <div id="banner-dots" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-1">
                        ${urls.map((_, index) => `<span class="dot w-2 h-2 rounded-full bg-white opacity-50 transition-opacity cursor-pointer" data-index="${index}"></span>`).join('')}
                    </div>
                </div>
            `;
        }
        
        // Logika Banner Slider
        let bannerInterval;
        let currentBannerIndex = 0;
        let bannerUrls = [];

        function startBannerSlider() {
            bannerUrls = [BANNER_DATA.url_banner1, BANNER_DATA.url_banner2, BANNER_DATA.url_banner3].filter(url => url);
            if (bannerUrls.length < 2) return;

            clearInterval(bannerInterval);
            const track = document.getElementById('banner-slide-track');
            const dots = document.querySelectorAll('.dot');
            if (!track || dots.length === 0) return;

            const updateDots = () => {
                dots.forEach(dot => dot.classList.remove('opacity-100'));
                dots[currentBannerIndex].classList.add('opacity-100');
            };

            const slide = () => {
                currentBannerIndex = (currentBannerIndex + 1) % bannerUrls.length;
                track.style.transform = `translateX(-${currentBannerIndex * 100 / bannerUrls.length}%)`;
                updateDots();
            };

            updateDots();
            dots.forEach(dot => {
                dot.addEventListener('click', (e) => {
                    currentBannerIndex = parseInt(e.target.getAttribute('data-index'));
                    track.style.transform = `translateX(-${currentBannerIndex * 100 / bannerUrls.length}%)`;
                    updateDots();
                    // Reset interval on manual click
                    clearInterval(bannerInterval);
                    bannerInterval = setInterval(slide, 3000);
                });
            });

            bannerInterval = setInterval(slide, 3000);
        }

        // Sub-render untuk Home Page (Detail Profil Klub)
        function renderDetailProfileKlub(profile) {
            const { isEditable, ...details } = profile;
            return `
                <div class="space-y-4">
                    <img src="${details.logo_klub || LOGO_PSSI}" alt="Logo Klub" class="w-32 h-32 object-contain rounded-lg shadow-md mx-auto">
                    <p class="text-2xl font-bold text-center text-blue-700">${details.nama_klub || 'N/A'}</p>
                    <p class="text-lg text-center text-gray-600 italic">"${details.julukan || 'Tanpa Julukan'}"</p>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        ${[
                            { label: 'Tanggal Berdiri', value: details.tanggal_berdiri },
                            { label: 'Alamat', value: details.alamat },
                            { label: 'No. Telepon', value: details.no_telpon_klub },
                            { label: 'Email', value: details.email_klub },
                            { label: 'Ketua', value: details.ketua },
                            { label: 'Sekretaris', value: details.sekretaris },
                            { label: 'Bendahara', value: details.bendahara },
                            { label: 'ID Klub', value: details.id_klub }
                        ].map(item => `
                            <div>
                                <p class="font-medium text-gray-500">${item.label}</p>
                                <p class="text-gray-800">${item.value || '-'}</p>
                            </div>
                        `).join('')}
                    </div>
                    ${isEditable ? `
                        <div class="flex justify-center pt-4 space-x-4">
                            <button onclick="document.getElementById('profile-club-container').innerHTML = renderFormProfileKlub(${JSON.stringify(details).replace(/"/g, '&quot;')})"
                                class="flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors shadow-md">
                                <i data-lucide="pencil" class="w-4 h-4 mr-2"></i> Edit Profil
                            </button>
                            <button onclick="handleDeleteProfileKlub('${details.id_klub}')"
                                class="flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors shadow-md">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Hapus
                            </button>
                        </div>
                    ` : `
                        <div class="pt-4 text-center text-sm text-red-500">
                            *Batas waktu edit (1 jam) telah berakhir.
                        </div>
                    `}
                </div>
            `;
        }

        // Sub-render untuk Home Page (Form CRUD Profil Klub)
        function renderFormProfileKlub(profile) {
            const isEdit = profile !== null;
            const title = isEdit ? `Edit Profil Klub: ${profile.nama_klub}` : 'Buat Profil Klub Baru';

            return `
                <form id="profile-club-form" class="space-y-4" onsubmit="event.preventDefault(); handleSaveProfileKlub('${isEdit ? 'update' : 'create'}');">
                    <p class="text-lg font-semibold text-gray-700 mb-4">${title}</p>

                    <!-- Logo Klub (Upload) -->
                    <div class="flex flex-col items-center space-y-2">
                        <img id="logo-preview" src="${isEdit ? profile.logo_klub : LOGO_PSSI}" alt="Logo Preview" class="w-24 h-24 object-contain rounded-lg border p-1 bg-gray-50">
                        <label class="block text-sm font-medium text-gray-700">Logo Klub</label>
                        <input type="file" id="logo_klub_file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                onchange="document.getElementById('logo-preview').src = window.URL.createObjectURL(this.files[0])">
                    </div>

                    <!-- Input Fields -->
                    ${[
                        { id: 'nama_klub', label: 'Nama Klub', type: 'text', required: true, value: isEdit ? profile.nama_klub : '' },
                        { id: 'julukan', label: 'Julukan', type: 'text', required: true, value: isEdit ? profile.julukan : '' },
                        { id: 'tanggal_berdiri', label: 'Tanggal Berdiri (YYYY-MM-DD)', type: 'date', required: true, value: isEdit ? profile.tanggal_berdiri : '' },
                        { id: 'alamat', label: 'Alamat', type: 'text', required: true, value: isEdit ? profile.alamat : '' },
                        { id: 'no_telpon_klub', label: 'No. Telepon Klub (Hanya Angka)', type: 'number', required: true, value: isEdit ? profile.no_telpon_klub : '' },
                        { id: 'email_klub', label: 'Email Klub', type: 'email', required: true, value: isEdit ? profile.email_klub : '' },
                        { id: 'ketua', label: 'Ketua', type: 'text', required: true, value: isEdit ? profile.ketua : '' },
                        { id: 'sekretaris', label: 'Sekretaris', type: 'text', required: true, value: isEdit ? profile.sekretaris : '' },
                        { id: 'bendahara', label: 'Bendahara', type: 'text', required: true, value: isEdit ? profile.bendahara : '' },
                    ].map(field => `
                        <div>
                            <label for="${field.id}" class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                            <input type="${field.type}" id="${field.id}" value="${field.value}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" ${field.required ? 'required' : ''}>
                        </div>
                    `).join('')}

                    <!-- Hidden ID for update -->
                    ${isEdit ? `<input type="hidden" id="id_klub" value="${profile.id_klub}">` : ''}

                    <div class="flex justify-end pt-4 space-x-3">
                        <button type="button" onclick="changePage('home')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Batal</button>
                        <button type="submit" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
                            <i data-lucide="${isEdit ? 'save' : 'plus'}" class="w-4 h-4 mr-2"></i> ${isEdit ? 'Simpan Perubahan' : 'Buat Profil'}
                        </button>
                    </div>
                </form>
            `;
        }
        
        // Logika CRUD Profil Klub
        async function handleSaveProfileKlub(mode) {
            const form = document.getElementById('profile-club-form');
            const data = {};
            const fields = ['nama_klub', 'julukan', 'tanggal_berdiri', 'alamat', 'no_telpon_klub', 'email_klub', 'ketua', 'sekretaris', 'bendahara'];

            // 1. Ambil data dari form
            fields.forEach(id => {
                data[id] = document.getElementById(id).value;
            });
            const logoFile = document.getElementById('logo_klub_file').files[0];

            // 2. Validasi
            if (data.email_klub && !/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(data.email_klub)) {
                showNotification("Format Email Klub tidak valid.", "error");
                return;
            }

            // 3. Handle Logo Upload
            if (logoFile) {
                try {
                    data.logo_klub = await fileToBase64(logoFile);
                } catch (e) {
                    showNotification("Gagal mengkonversi file logo.", "error");
                    return;
                }
            } else if (mode === 'update') {
                // Pertahankan URL logo lama jika tidak ada file baru
                const currentProfile = PROFILE_KLUB_DATA.find(p => p.id_klub === CURRENT_USER.id_klub);
                data.logo_klub = currentProfile ? currentProfile.logo_klub : '';
            }

            // 4. Kirim ke API
            const action = mode === 'create' ? 'createProfileKlub' : 'updateProfileKlub';
            const result = await apiFetch(action, 'POST', data);

            if (result && result.status === 'success') {
                showNotification(`Profil Klub berhasil di${mode === 'create' ? 'buat' : 'perbarui'}!`, 'success');
                // Refresh halaman Home
                await changePage('home', true);
            }
        }

        async function handleDeleteProfileKlub(id_klub) {
            const confirmation = await showConfirmation(`Anda yakin ingin menghapus profil klub ID ${id_klub}? Data yang sudah dihapus tidak bisa dikembalikan.`);
            if (!confirmation) return;

            const result = await apiFetch('deleteProfileKlub', 'POST', { id_klub });

            if (result && result.status === 'success') {
                showNotification('Profil Klub berhasil dihapus.', 'success');
                await changePage('home', true);
            }
        }
        
        // --- ADMIN_PUSAT/MEDIA melihat daftar Profil Klub ---
        function renderListProfileKlub(profiles) {
            return `
                <div class="space-y-4">
                    <p class="text-sm text-gray-500">Total ${profiles.length} Profil Klub terdaftar.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${profiles.map(p => `
                            <div class="bg-gray-50 p-4 rounded-lg shadow-md border border-gray-200 flex items-center space-x-4">
                                <img src="${p.logo_klub || LOGO_PSSI}" alt="Logo Klub" class="w-12 h-12 object-contain rounded-full border">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${p.nama_klub || p.id_klub}</p>
                                    <p class="text-xs text-gray-500">${p.julukan || 'Belum ada julukan'}</p>
                                </div>
                                ${CURRENT_USER.type_users === 'ADMIN_PUSAT' ? `
                                    <button onclick="document.getElementById('profile-club-container').innerHTML = renderDetailProfileKlub(${JSON.stringify(p).replace(/"/g, '&quot;')})"
                                        class="p-2 text-blue-600 hover:text-blue-800 transition-colors rounded-full bg-blue-100">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ${CURRENT_USER.type_users === 'ADMIN_PUSAT' ? `
                        <div class="pt-4 text-center text-sm text-gray-500">
                            Sebagai ADMIN_PUSAT, Anda dapat melihat dan mengelola semua profil klub.
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // --- PEMAIN PAGE ---

        async function renderPemainPage() {
            const result = await apiFetch('getPemain', 'GET');
            PEMAIN_DATA = result.data || [];

            return `
                ${renderHeader('Data Pemain')}
                <div class="max-w-xl mx-auto p-4 space-y-4">
                    ${renderSearchAndAddButton('pemain')}
                    <div id="pemain-list" class="grid grid-cols-2 gap-4">
                        ${PEMAIN_DATA.map(p => renderPemainCard(p)).join('')}
                    </div>
                </div>
                ${renderModalContainer('pemain-modal')}
            `;
        }

        function renderSearchAndAddButton(type) {
            const typeLabel = type === 'pemain' ? 'Pemain' : 'Official';
            const canAdd = CURRENT_USER.type_users === 'ADMIN_PUSAT' || CURRENT_USER.type_users === 'ADMIN_KLUB';

            return `
                <div class="flex space-x-2">
                    <input type="text" id="${type}-search" placeholder="Cari ${typeLabel}..." onkeyup="filter${typeLabel}List()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    ${canAdd ? `
                        <button onclick="show${typeLabel}Form(null)" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md flex items-center">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span class="hidden sm:inline ml-2">Tambah</span>
                        </button>
                    ` : ''}
                </div>
            `;
        }

        function renderPemainCard(p) {
            return `
                <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col items-center text-center cursor-pointer hover:bg-gray-50 transition-colors" onclick="showPemainDetail(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                    <img src="${p.photo_pemain_url || 'https://placehold.co/100x100/A0AEC0/ffffff?text=FOTO'}" alt="${p.nama_pemain}" class="w-20 h-20 object-cover rounded-full border-2 border-blue-500 mb-2">
                    <p class="text-sm font-semibold text-gray-800 truncate w-full">${p.nama_pemain}</p>
                    <p class="text-xs text-gray-600">No. ${p.no_punggung || '-'} | ${p.posisi || '-'}</p>
                    <p class="text-xs text-gray-500">Usia: ${p.usia || '-'}</p>
                </div>
            `;
        }
        
        // Logika Filter Pemain
        function filterPemainList() {
            const searchTerm = document.getElementById('pemain-search').value.toLowerCase();
            const listContainer = document.getElementById('pemain-list');
            const filteredData = PEMAIN_DATA.filter(p =>
                p.nama_pemain.toLowerCase().includes(searchTerm) ||
                p.posisi.toLowerCase().includes(searchTerm) ||
                p.id_klub.toLowerCase().includes(searchTerm)
            );
            listContainer.innerHTML = filteredData.map(p => renderPemainCard(p)).join('');
            lucide.createIcons();
        }

        // Modals Pemain (Detail & Form)
        function renderPemainDetail(p) {
            return `
                <div class="w-full max-w-lg p-6 bg-white rounded-xl">
                    <h3 class="text-xl font-bold mb-4 text-center">Detail Pemain</h3>
                    <div class="flex flex-col items-center space-y-4">
                        <img src="${p.photo_pemain_url || 'https://placehold.co/120x120/A0AEC0/ffffff?text=FOTO'}" alt="${p.nama_pemain}" class="w-24 h-24 object-cover rounded-full border-4 border-blue-500">
                        <p class="text-2xl font-bold text-gray-800">${p.nama_pemain}</p>
                        <p class="text-lg text-gray-600">No. Punggung: ${p.no_punggung || '-'}</p>
                    </div>
                    <div class="mt-6 space-y-2 text-sm">
                        ${[
                            { label: 'ID Pemain', value: p.id_pemain },
                            { label: 'Tanggal Lahir', value: p.tanggal_lahir },
                            { label: 'Usia', value: `${p.usia} tahun` },
                            { label: 'Nama Punggung', value: p.nama_punggung },
                            { label: 'Posisi', value: p.posisi },
                            { label: 'ID Klub', value: p.id_klub }
                        ].map(item => `
                            <div class="flex justify-between border-b pb-1">
                                <span class="font-medium text-gray-500">${item.label}</span>
                                <span class="text-gray-800">${item.value || '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${p.isEditable && (CURRENT_USER.type_users === 'ADMIN_PUSAT' || CURRENT_USER.id_klub === p.id_klub) ? `
                        <div class="flex justify-end pt-6 space-x-3">
                            <button onclick="showPemainForm(${JSON.stringify(p).replace(/"/g, '&quot;')})" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">
                                <i data-lucide="pencil" class="w-4 h-4 mr-2"></i> Edit
                            </button>
                            <button onclick="handleDeletePemain('${p.id_pemain}')" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Hapus
                            </button>
                        </div>
                    ` : (CURRENT_USER.type_users === 'ADMIN_KLUB' && CURRENT_USER.id_klub === p.id_klub ? `
                        <div class="pt-4 text-center text-sm text-red-500">*Batas waktu edit (1 jam) telah berakhir.</div>
                    ` : '')}
                    <button onclick="closeModal('pemain-modal')" class="absolute top-3 right-3 p-2 text-gray-500 hover:text-gray-800">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
        }

        function showPemainDetail(p) {
            const modal = document.getElementById('pemain-modal');
            modal.innerHTML = renderPemainDetail(p);
            modal.classList.add('show');
            lucide.createIcons();
        }

        function showPemainForm(p) {
            const isEdit = p !== null;
            const title = isEdit ? `Edit Pemain: ${p.nama_pemain}` : 'Tambah Pemain Baru';
            const modal = document.getElementById('pemain-modal');
            const positions = ['Kiper', 'Bek Kanan', 'Bek Tengah', 'Bek Kiri', 'Gelandang kanan', 'Gelandang Tengah', 'Gelandang Kiri', 'Penyerang'];

            modal.innerHTML = `
                <div class="w-full max-w-lg p-6 bg-white rounded-xl">
                    <h3 class="text-xl font-bold mb-4 text-center">${title}</h3>
                    <form id="pemain-form" class="space-y-4" onsubmit="event.preventDefault(); handleSavePemain('${isEdit ? 'update' : 'create'}');">
                        <input type="hidden" id="id_pemain" value="${isEdit ? p.id_pemain : ''}">
                        
                        <!-- Photo Pemain (Upload) -->
                        <div class="flex flex-col items-center space-y-2">
                            <img id="photo-preview" src="${isEdit ? p.photo_pemain_url : 'https://placehold.co/100x100/A0AEC0/ffffff?text=FOTO'}" alt="Foto Preview" class="w-24 h-24 object-cover rounded-full border-2 p-1 bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700">Foto Pemain</label>
                            <input type="file" id="photo_pemain_file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                    onchange="document.getElementById('photo-preview').src = window.URL.createObjectURL(this.files[0])">
                        </div>

                        <!-- Input Fields -->
                        ${[
                            { id: 'nama_pemain', label: 'Nama Pemain', type: 'text', required: true, value: isEdit ? p.nama_pemain : '' },
                            { id: 'tanggal_lahir', label: 'Tanggal Lahir (YYYY-MM-DD)', type: 'date', required: true, value: isEdit ? p.tanggal_lahir : '' },
                            { id: 'nama_punggung', label: 'Nama Punggung', type: 'text', required: true, value: isEdit ? p.nama_punggung : '' },
                            { id: 'no_punggung', label: 'No. Punggung (Hanya Angka)', type: 'number', required: true, value: isEdit ? p.no_punggung : '' },
                        ].map(field => `
                            <div>
                                <label for="${field.id}" class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                                <input type="${field.type}" id="${field.id}" value="${field.value}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" ${field.required ? 'required' : ''}>
                            </div>
                        `).join('')}

                        <!-- Posisi Select -->
                        <div>
                            <label for="posisi" class="block text-sm font-medium text-gray-700 mb-1">Posisi</label>
                            <select id="posisi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                                <option value="">Pilih Posisi</option>
                                ${positions.map(pos => `<option value="${pos}" ${isEdit && p.posisi === pos ? 'selected' : ''}>${pos}</option>`).join('')}
                            </select>
                        </div>

                        <div class="flex justify-end pt-4 space-x-3">
                            <button type="button" onclick="closeModal('pemain-modal'); ${isEdit ? `showPemainDetail(${JSON.stringify(p).replace(/"/g, '&quot;')})` : `changePage('pemain', true)`}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Batal</button>
                            <button type="submit" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
                                <i data-lucide="${isEdit ? 'save' : 'plus'}" class="w-4 h-4 mr-2"></i> ${isEdit ? 'Simpan' : 'Tambah'}
                            </button>
                        </div>
                    </form>
                    <button onclick="closeModal('pemain-modal')" class="absolute top-3 right-3 p-2 text-gray-500 hover:text-gray-800">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            modal.classList.add('show');
            lucide.createIcons();
        }

        async function handleSavePemain(mode) {
            const form = document.getElementById('pemain-form');
            const data = {};
            const fields = ['nama_pemain', 'tanggal_lahir', 'nama_punggung', 'no_punggung', 'posisi'];
            fields.forEach(id => { data[id] = document.getElementById(id).value; });
            data.id_pemain = document.getElementById('id_pemain').value;
            const photoFile = document.getElementById('photo_pemain_file').files[0];
            const currentPemain = PEMAIN_DATA.find(p => p.id_pemain === data.id_pemain);

            // Validasi
            if (data.no_punggung && isNaN(data.no_punggung)) {
                showNotification("Nomor punggung harus berupa angka.", "error");
                return;
            }

            if (photoFile) {
                try {
                    data.photo_pemain_url = await fileToBase64(photoFile);
                } catch (e) {
                    showNotification("Gagal mengkonversi file foto.", "error");
                    return;
                }
            } else if (mode === 'update' && currentPemain) {
                data.photo_pemain_url = currentPemain.photo_pemain_url;
            } else if (mode === 'create') {
                data.photo_pemain_url = '';
            }

            const action = mode === 'create' ? 'createPemain' : 'updatePemain';
            const result = await apiFetch(action, 'POST', data);

            if (result && result.status === 'success') {
                showNotification(`Pemain berhasil di${mode === 'create' ? 'tambah' : 'perbarui'}!`, 'success');
                closeModal('pemain-modal');
                await changePage('pemain', true);
            }
        }

        async function handleDeletePemain(id_pemain) {
            const confirmation = await showConfirmation(`Anda yakin ingin menghapus Pemain ID ${id_pemain}?`);
            if (!confirmation) return;

            const result = await apiFetch('deletePemain', 'POST', null, 1, { id_pemain });

            if (result && result.status === 'success') {
                showNotification('Pemain berhasil dihapus.', 'success');
                closeModal('pemain-modal');
                await changePage('pemain', true);
            }
        }

        // --- OFFICIAL PAGE ---

        async function renderOfficialPage() {
            const result = await apiFetch('getOfficial', 'GET');
            OFFICIAL_DATA = result.data || [];

            return `
                ${renderHeader('Data Official')}
                <div class="max-w-xl mx-auto p-4 space-y-4">
                    ${renderSearchAndAddButton('official')}
                    <div id="official-list" class="grid grid-cols-2 gap-4">
                        ${OFFICIAL_DATA.map(o => renderOfficialCard(o)).join('')}
                    </div>
                </div>
                ${renderModalContainer('official-modal')}
            `;
        }

        function renderOfficialCard(o) {
            return `
                <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col items-center text-center cursor-pointer hover:bg-gray-50 transition-colors" onclick="showOfficialDetail(${JSON.stringify(o).replace(/"/g, '&quot;')})">
                    <img src="${o.photo_official_url || 'https://placehold.co/100x100/A0AEC0/ffffff?text=FOTO'}" alt="${o.nama_official}" class="w-20 h-20 object-cover rounded-full border-2 border-blue-500 mb-2">
                    <p class="text-sm font-semibold text-gray-800 truncate w-full">${o.nama_official}</p>
                    <p class="text-xs text-gray-600">${o.jabatan || '-'}</p>
                    <p class="text-xs text-gray-500">Usia: ${o.usia || '-'}</p>
                </div>
            `;
        }
        
        // Logika Filter Official
        function filterOfficialList() {
            const searchTerm = document.getElementById('official-search').value.toLowerCase();
            const listContainer = document.getElementById('official-list');
            const filteredData = OFFICIAL_DATA.filter(o =>
                o.nama_official.toLowerCase().includes(searchTerm) ||
                o.jabatan.toLowerCase().includes(searchTerm) ||
                o.id_klub.toLowerCase().includes(searchTerm)
            );
            listContainer.innerHTML = filteredData.map(o => renderOfficialCard(o)).join('');
            lucide.createIcons();
        }

        // Modals Official (Detail & Form)
        function renderOfficialDetail(o) {
            return `
                <div class="w-full max-w-lg p-6 bg-white rounded-xl">
                    <h3 class="text-xl font-bold mb-4 text-center">Detail Official</h3>
                    <div class="flex flex-col items-center space-y-4">
                        <img src="${o.photo_official_url || 'https://placehold.co/120x120/A0AEC0/ffffff?text=FOTO'}" alt="${o.nama_official}" class="w-24 h-24 object-cover rounded-full border-4 border-blue-500">
                        <p class="text-2xl font-bold text-gray-800">${o.nama_official}</p>
                        <p class="text-lg text-gray-600">${o.jabatan || '-'}</p>
                    </div>
                    <div class="mt-6 space-y-2 text-sm">
                        ${[
                            { label: 'ID Official', value: o.id_official },
                            { label: 'Tanggal Lahir', value: o.tanggal_lahir },
                            { label: 'Usia', value: `${o.usia} tahun` },
                            { label: 'ID Klub', value: o.id_klub }
                        ].map(item => `
                            <div class="flex justify-between border-b pb-1">
                                <span class="font-medium text-gray-500">${item.label}</span>
                                <span class="text-gray-800">${item.value || '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${o.isEditable && (CURRENT_USER.type_users === 'ADMIN_PUSAT' || CURRENT_USER.id_klub === o.id_klub) ? `
                        <div class="flex justify-end pt-6 space-x-3">
                            <button onclick="showOfficialForm(${JSON.stringify(o).replace(/"/g, '&quot;')})" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">
                                <i data-lucide="pencil" class="w-4 h-4 mr-2"></i> Edit
                            </button>
                            <button onclick="handleDeleteOfficial('${o.id_official}')" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Hapus
                            </button>
                        </div>
                    ` : (CURRENT_USER.type_users === 'ADMIN_KLUB' && CURRENT_USER.id_klub === o.id_klub ? `
                        <div class="pt-4 text-center text-sm text-red-500">*Batas waktu edit (1 jam) telah berakhir.</div>
                    ` : '')}
                    <button onclick="closeModal('official-modal')" class="absolute top-3 right-3 p-2 text-gray-500 hover:text-gray-800">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
        }

        function showOfficialDetail(o) {
            const modal = document.getElementById('official-modal');
            modal.innerHTML = renderOfficialDetail(o);
            modal.classList.add('show');
            lucide.createIcons();
        }

        function showOfficialForm(o) {
            const isEdit = o !== null;
            const title = isEdit ? `Edit Official: ${o.nama_official}` : 'Tambah Official Baru';
            const modal = document.getElementById('official-modal');
            const positions = ['Manejer', 'Asisten Manejer', 'Pelatih', 'Asisten Pelatih', 'Pelatih Kiper', 'Pelatih Fisik', 'Medis', 'Staff Lainnya'];

            modal.innerHTML = `
                <div class="w-full max-w-lg p-6 bg-white rounded-xl">
                    <h3 class="text-xl font-bold mb-4 text-center">${title}</h3>
                    <form id="official-form" class="space-y-4" onsubmit="event.preventDefault(); handleSaveOfficial('${isEdit ? 'update' : 'create'}');">
                        <input type="hidden" id="id_official" value="${isEdit ? o.id_official : ''}">
                        
                        <!-- Photo Official (Upload) -->
                        <div class="flex flex-col items-center space-y-2">
                            <img id="official-photo-preview" src="${isEdit ? o.photo_official_url : 'https://placehold.co/100x100/A0AEC0/ffffff?text=FOTO'}" alt="Foto Preview" class="w-24 h-24 object-cover rounded-full border-2 p-1 bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700">Foto Official</label>
                            <input type="file" id="photo_official_file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                    onchange="document.getElementById('official-photo-preview').src = window.URL.createObjectURL(this.files[0])">
                        </div>

                        <!-- Input Fields -->
                        ${[
                            { id: 'nama_official', label: 'Nama Official', type: 'text', required: true, value: isEdit ? o.nama_official : '' },
                            { id: 'tanggal_lahir', label: 'Tanggal Lahir (YYYY-MM-DD)', type: 'date', required: true, value: isEdit ? o.tanggal_lahir : '' },
                        ].map(field => `
                            <div>
                                <label for="${field.id}" class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                                <input type="${field.type}" id="${field.id}" value="${field.value}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" ${field.required ? 'required' : ''}>
                            </div>
                        `).join('')}

                        <!-- Jabatan Select -->
                        <div>
                            <label for="jabatan" class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label>
                            <select id="jabatan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                                <option value="">Pilih Jabatan</option>
                                ${positions.map(pos => `<option value="${pos}" ${isEdit && o.jabatan === pos ? 'selected' : ''}>${pos}</option>`).join('')}
                            </select>
                        </div>

                        <div class="flex justify-end pt-4 space-x-3">
                            <button type="button" onclick="closeModal('official-modal'); ${isEdit ? `showOfficialDetail(${JSON.stringify(o).replace(/"/g, '&quot;')})` : `changePage('official', true)`}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Batal</button>
                            <button type="submit" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
                                <i data-lucide="${isEdit ? 'save' : 'plus'}" class="w-4 h-4 mr-2"></i> ${isEdit ? 'Simpan' : 'Tambah'}
                            </button>
                        </div>
                    </form>
                    <button onclick="closeModal('official-modal')" class="absolute top-3 right-3 p-2 text-gray-500 hover:text-gray-800">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            modal.classList.add('show');
            lucide.createIcons();
        }

        async function handleSaveOfficial(mode) {
            const form = document.getElementById('official-form');
            const data = {};
            const fields = ['nama_official', 'tanggal_lahir', 'jabatan'];
            fields.forEach(id => { data[id] = document.getElementById(id).value; });
            data.id_official = document.getElementById('id_official').value;
            const photoFile = document.getElementById('photo_official_file').files[0];
            const currentOfficial = OFFICIAL_DATA.find(o => o.id_official === data.id_official);

            if (photoFile) {
                try {
                    data.photo_official_url = await fileToBase64(photoFile);
                } catch (e) {
                    showNotification("Gagal mengkonversi file foto.", "error");
                    return;
                }
            } else if (mode === 'update' && currentOfficial) {
                data.photo_official_url = currentOfficial.photo_official_url;
            } else if (mode === 'create') {
                data.photo_official_url = '';
            }

            const action = mode === 'create' ? 'createOfficial' : 'updateOfficial';
            const result = await apiFetch(action, 'POST', data);

            if (result && result.status === 'success') {
                showNotification(`Official berhasil di${mode === 'create' ? 'tambah' : 'perbarui'}!`, 'success');
                closeModal('official-modal');
                await changePage('official', true);
            }
        }

        async function handleDeleteOfficial(id_official) {
            const confirmation = await showConfirmation(`Anda yakin ingin menghapus Official ID ${id_official}?`);
            if (!confirmation) return;

            const result = await apiFetch('deleteOfficial', 'POST', null, 1, { id_official });

            if (result && result.status === 'success') {
                showNotification('Official berhasil dihapus.', 'success');
                closeModal('official-modal');
                await changePage('official', true);
            }
        }


        // --- KOMPETISI PAGE ---

        async function renderKompetisiPage() {
            const result = await apiFetch('getListKompetisi', 'GET');
            KOMPETISI_DATA = result.data || [];

            return `
                ${renderHeader('Daftar Kompetisi')}
                <div class="max-w-xl mx-auto p-4 space-y-4">
                    ${CURRENT_USER.type_users === 'ADMIN_PUSAT' ? `
                        <button onclick="showKompetisiForm(null)" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Tambah Kompetisi Baru
                        </button>
                    ` : ''}
                    <div id="kompetisi-list" class="space-y-4">
                        ${KOMPETISI_DATA.map(k => renderKompetisiCard(k)).join('')}
                        ${KOMPETISI_DATA.length === 0 ? '<p class="text-center text-gray-500">Tidak ada kompetisi yang terdaftar.</p>' : ''}
                    </div>
                </div>
                ${renderModalContainer('kompetisi-modal')}
            `;
        }

        function renderKompetisiCard(k) {
            const statusClass = k.isRegistrationOpen ? 'bg-green-500' : 'bg-red-500';
            const statusText = k.isRegistrationOpen ? 'Pendaftaran DIBUKA' : 'Pendaftaran DITUTUP';
            const buttonText = k.isRegistrationOpen ? 'DAFTAR KLUB' : 'LIHAT DETAIL';
            const canEdit = k.isEditable && CURRENT_USER.type_users === 'ADMIN_PUSAT';

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-600 flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4">
                    <img src="${k.url_logo_liga || LOGO_PSSI}" alt="Logo Liga" class="w-16 h-16 object-contain rounded-full border p-1">
                    <div class="flex-1 text-center md:text-left">
                        <p class="text-lg font-bold text-blue-700">${k.nama_kompetisi}</p>
                        <p class="text-sm text-gray-600">Max Usia: ${k.umur_maksimal} | ID: ${k.id_kompetisi}</p>
                        <p class="text-xs text-gray-500">Mulai: ${k.tanggal_mulai_liga}</p>
                        <p class="text-xs font-medium text-gray-700">Pendaftaran: ${k.tanggal_awal_pendaftaran} s/d ${k.tanggal_akhir_pendaftaran}</p>
                        <span class="text-xs font-semibold text-white px-2 py-0.5 rounded-full ${statusClass}">${statusText}</span>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button onclick="renderDetailKompetisi('${k.id_kompetisi}')" class="w-32 bg-blue-600 text-white text-sm p-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">${buttonText}</button>
                        ${canEdit ? `
                            <button onclick="showKompetisiForm(${JSON.stringify(k).replace(/"/g, '&quot;')})" class="w-32 bg-green-600 text-white text-sm p-2 rounded-lg hover:bg-green-700 transition-colors shadow-md flex items-center justify-center">
                                <i data-lucide="pencil" class="w-4 h-4 mr-2"></i> Edit
                            </button>
                            <button onclick="handleDeleteKompetisi('${k.id_kompetisi}')" class="w-32 bg-red-600 text-white text-sm p-2 rounded-lg hover:bg-red-700 transition-colors shadow-md flex items-center justify-center">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Hapus
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Form CRUD Kompetisi (Hanya ADMIN_PUSAT)
        function showKompetisiForm(k) {
            if (CURRENT_USER.type_users !== 'ADMIN_PUSAT') return;
            const isEdit = k !== null;
            const title = isEdit ? `Edit Kompetisi: ${k.nama_kompetisi}` : 'Tambah Kompetisi Baru';
            
            const modal = document.getElementById('kompetisi-modal');
            modal.innerHTML = `
                <div class="w-full max-w-lg p-6 bg-white rounded-xl">
                    <h3 class="text-xl font-bold mb-4 text-center">${title}</h3>
                    <form id="kompetisi-form" class="space-y-4" onsubmit="event.preventDefault(); handleSaveKompetisi('${isEdit ? 'update' : 'create'}');">
                        <input type="hidden" id="id_kompetisi" value="${isEdit ? k.id_kompetisi : ''}">
                        
                        <!-- Logo Liga (Upload) -->
                        <div class="flex flex-col items-center space-y-2">
                            <img id="liga-logo-preview" src="${isEdit ? k.url_logo_liga : 'https://placehold.co/100x100/A0AEC0/ffffff?text=LOGO'}" alt="Logo Preview" class="w-24 h-24 object-contain rounded-full border-2 p-1 bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700">Logo Liga</label>
                            <input type="file" id="logo_liga_file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                    onchange="document.getElementById('liga-logo-preview').src = window.URL.createObjectURL(this.files[0])">
                        </div>

                        <!-- Input Fields -->
                        ${[
                            { id: 'nama_kompetisi', label: 'Nama Kompetisi', type: 'text', required: true, value: isEdit ? k.nama_kompetisi : '' },
                            { id: 'umur_maksimal', label: 'Umur Maksimal (Hanya Angka)', type: 'number', required: true, value: isEdit ? k.umur_maksimal : '' },
                            { id: 'tanggal_mulai_liga', label: 'Tanggal Mulai Liga (YYYY-MM-DD)', type: 'date', required: true, value: isEdit ? k.tanggal_mulai_liga : '' },
                            { id: 'tanggal_awal_pendaftaran', label: 'Tanggal Awal Pendaftaran (YYYY-MM-DD)', type: 'date', required: true, value: isEdit ? k.tanggal_awal_pendaftaran : '' },
                            { id: 'tanggal_akhir_pendaftaran', label: 'Tanggal Akhir Pendaftaran (YYYY-MM-DD)', type: 'date', required: true, value: isEdit ? k.tanggal_akhir_pendaftaran : '' },
                        ].map(field => `
                            <div>
                                <label for="${field.id}" class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                                <input type="${field.type}" id="${field.id}" value="${field.value}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" ${field.required ? 'required' : ''}>
                            </div>
                        `).join('')}

                        <div class="flex justify-end pt-4 space-x-3">
                            <button type="button" onclick="closeModal('kompetisi-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Batal</button>
                            <button type="submit" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
                                <i data-lucide="${isEdit ? 'save' : 'plus'}" class="w-4 h-4 mr-2"></i> ${isEdit ? 'Simpan' : 'Buat'}
                            </button>
                        </div>
                    </form>
                    <button onclick="closeModal('kompetisi-modal')" class="absolute top-3 right-3 p-2 text-gray-500 hover:text-gray-800">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            modal.classList.add('show');
            lucide.createIcons();
        }

        async function handleSaveKompetisi(mode) {
            const form = document.getElementById('kompetisi-form');
            const data = {};
            const fields = ['nama_kompetisi', 'umur_maksimal', 'tanggal_mulai_liga', 'tanggal_awal_pendaftaran', 'tanggal_akhir_pendaftaran'];
            fields.forEach(id => { data[id] = document.getElementById(id).value; });
            data.id_kompetisi = document.getElementById('id_kompetisi').value;
            const logoFile = document.getElementById('logo_liga_file').files[0];
            const currentKompetisi = KOMPETISI_DATA.find(k => k.id_kompetisi === data.id_kompetisi);

            if (logoFile) {
                try {
                    data.url_logo_liga = await fileToBase64(logoFile);
                } catch (e) {
                    showNotification("Gagal mengkonversi file logo.", "error");
                    return;
                }
            } else if (mode === 'update' && currentKompetisi) {
                data.url_logo_liga = currentKompetisi.url_logo_liga;
            } else if (mode === 'create') {
                data.url_logo_liga = '';
            }

            const action = mode === 'create' ? 'createKompetisi' : 'updateKompetisi';
            const result = await apiFetch(action, 'POST', data);

            if (result && result.status === 'success') {
                showNotification(`Kompetisi berhasil di${mode === 'create' ? 'buat' : 'perbarui'}!`, 'success');
                closeModal('kompetisi-modal');
                await changePage('kompetisi', true);
            }
        }

        async function handleDeleteKompetisi(id_kompetisi) {
            const confirmation = await showConfirmation(`Anda yakin ingin menghapus Kompetisi ID ${id_kompetisi}?`);
            if (!confirmation) return;

            const result = await apiFetch('deleteKompetisi', 'POST', null, 1, { id_kompetisi });

            if (result && result.status === 'success') {
                showNotification('Kompetisi berhasil dihapus.', 'success');
                await changePage('kompetisi', true);
            }
        }
        
        // Form Detail Kompetisi (Subform Pemain & Official)
        async function renderDetailKompetisi(idKompetisi) {
            CURRENT_PAGE = 'detailKompetisi';
            const container = document.getElementById('app-container');
            const kompetisi = KOMPETISI_DATA.find(k => k.id_kompetisi === idKompetisi);
            if (!kompetisi) {
                container.innerHTML = renderNotFoundPage('Kompetisi tidak ditemukan.');
                return;
            }

            // Fetch Subform Data
            const [playersResult, officialsResult, comboPlayerResult, comboOfficialResult] = await Promise.all([
                apiFetch('getPlayersForCompetition', 'GET', { id_kompetisi: idKompetisi }),
                apiFetch('getOfficialsForCompetition', 'GET', { id_kompetisi: idKompetisi }),
                apiFetch('getPemainList', 'GET', { id_kompetisi: idKompetisi }),
                apiFetch('getOfficialList', 'GET')
            ]);

            const playersInComp = playersResult.data || [];
            const officialsInComp = officialsResult.data || [];
            COMBOBOX_PLAYER_LIST = comboPlayerResult.data || [];
            COMBOBOX_OFFICIAL_LIST = comboOfficialResult.data || [];

            const isRegistrationOpen = new Date().getTime() >= new Date(kompetisi.tanggal_awal_pendaftaran).getTime() &&
                                       new Date().getTime() <= new Date(kompetisi.tanggal_akhir_pendaftaran).getTime();
            
            const canEditSubform = (CURRENT_USER.type_users === 'ADMIN_PUSAT' || CURRENT_USER.type_users === 'ADMIN_KLUB') && isRegistrationOpen;

            container.innerHTML = `
                ${renderHeader(`Pendaftaran Kompetisi: ${kompetisi.nama_kompetisi}`)}
                <div class="max-w-4xl mx-auto p-4 space-y-6">
                    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-600">
                        <p class="text-xl font-bold text-blue-700">${kompetisi.nama_kompetisi}</p>
                        <p class="text-sm text-gray-600">Max Usia: ${kompetisi.umur_maksimal}</p>
                        <p class="text-sm font-medium text-gray-700">Pendaftaran: ${kompetisi.tanggal_awal_pendaftaran} s/d ${kompetisi.tanggal_akhir_pendaftaran}</p>
                        <span class="text-xs font-semibold text-white px-2 py-0.5 rounded-full ${isRegistrationOpen ? 'bg-green-500' : 'bg-red-500'}">${isRegistrationOpen ? 'Pendaftaran DIBUKA' : 'Pendaftaran DITUTUP'}</span>
                    </div>

                    <div id="subform-pendaftaran" class="space-y-6">
                        ${renderPemainPraKompetisiSubform(kompetisi, playersInComp, canEditSubform)}
                        ${renderOfficialPraKompetisiSubform(kompetisi, officialsInComp, canEditSubform)}
                    </div>
                    
                    <button onclick="changePage('kompetisi')" class="w-full bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition-colors shadow-md flex items-center justify-center">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Kembali ke Daftar Kompetisi
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderPemainPraKompetisiSubform(kompetisi, playersInComp, canEdit) {
            const maxPlayers = 25;
            const emptyRows = Array(maxPlayers - playersInComp.length > 0 ? maxPlayers - playersInComp.length : 0).fill({});
            const initialPlayers = playersInComp.concat(emptyRows).slice(0, maxPlayers);
            
            return `
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h4 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Pemain Pra-Kompetisi</h4>
                    ${!canEdit && CURRENT_USER.type_users === 'ADMIN_KLUB' ? '<p class="text-sm text-red-500 mb-4">*Pendaftaran telah ditutup.</p>' : ''}
                    <form id="pemain-prakompetisi-form" onsubmit="event.preventDefault(); handleSavePemainPraKompetisi('${kompetisi.id_kompetisi}')">
                        <table class="w-full text-xs md:text-sm whitespace-nowrap">
                            <thead>
                                <tr class="text-left bg-gray-50">
                                    <th class="p-2 w-1/4">ID/Nama Pemain</th>
                                    <th class="p-2 w-1/4 hidden sm:table-cell">Posisi</th>
                                    <th class="p-2 w-1/4 hidden md:table-cell">Klub</th>
                                    ${canEdit ? '<th class="p-2 w-1/12">Hapus</th>' : ''}
                                </tr>
                            </thead>
                            <tbody id="pemain-prakompetisi-body">
                                ${initialPlayers.map((p, index) => renderPemainPraKompetisiRow(p, index, canEdit)).join('')}
                            </tbody>
                        </table>
                        
                        ${canEdit ? `
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> Simpan Pendaftaran Pemain
                                </button>
                            </div>
                        ` : ''}
                    </form>
                </div>
            `;
        }

        function renderPemainPraKompetisiRow(p, index, canEdit) {
            const playerOptions = COMBOBOX_PLAYER_LIST.map(player => {
                const isSelected = p.id_pemain === player.id_pemain;
                return `<option value="${player.id_pemain}" ${isSelected ? 'selected' : ''}>${player.nama_pemain} (${player.id_pemain})</option>`;
            }).join('');

            return `
                <tr id="player-row-${index}" class="border-b hover:bg-gray-50">
                    <td class="p-2">
                        ${canEdit ? `
                            <select id="player-select-${index}" class="w-full border rounded-md p-1 bg-white text-xs md:text-sm" onchange="updatePlayerDetails(${index}, this.value, 'player')">
                                <option value="">Pilih Pemain</option>
                                ${playerOptions}
                            </select>
                            <p class="text-xs text-gray-500 mt-1" id="player-info-${index}">${p.posisi || '-'}</p>
                        ` : `
                            <p class="font-medium text-gray-800">${p.nama_pemain || '-'}</p>
                            <p class="text-xs text-gray-500">${p.id_pemain || '-'}</p>
                        `}
                    </td>
                    <td class="p-2 hidden sm:table-cell">
                        ${canEdit ? `<input type="text" id="player-pos-${index}" value="${p.posisi || ''}" class="w-full border-none bg-transparent" readonly>` : (p.posisi || '-')}
                    </td>
                    <td class="p-2 hidden md:table-cell">
                        ${canEdit ? `<input type="text" id="player-klub-${index}" value="${p.id_klub || ''}" class="w-full border-none bg-transparent" readonly>` : (p.id_klub || '-')}
                    </td>
                    ${canEdit ? `
                        <td class="p-2 text-center">
                            <button type="button" onclick="clearPlayerRow(${index})" class="p-1 text-red-600 hover:text-red-800">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    ` : ''}
                </tr>
            `;
        }

        function renderOfficialPraKompetisiSubform(kompetisi, officialsInComp, canEdit) {
            const maxOfficials = 10;
            const emptyRows = Array(maxOfficials - officialsInComp.length > 0 ? maxOfficials - officialsInComp.length : 0).fill({});
            const initialOfficials = officialsInComp.concat(emptyRows).slice(0, maxOfficials);

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h4 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Official Pra-Kompetisi</h4>
                    ${!canEdit && CURRENT_USER.type_users === 'ADMIN_KLUB' ? '<p class="text-sm text-red-500 mb-4">*Pendaftaran telah ditutup.</p>' : ''}
                    <form id="official-prakompetisi-form" onsubmit="event.preventDefault(); handleSaveOfficialPraKompetisi('${kompetisi.id_kompetisi}')">
                        <table class="w-full text-xs md:text-sm whitespace-nowrap">
                            <thead>
                                <tr class="text-left bg-gray-50">
                                    <th class="p-2 w-1/4">ID/Nama Official</th>
                                    <th class="p-2 w-1/4 hidden sm:table-cell">Jabatan</th>
                                    <th class="p-2 w-1/4 hidden md:table-cell">Klub</th>
                                    ${canEdit ? '<th class="p-2 w-1/12">Hapus</th>' : ''}
                                </tr>
                            </thead>
                            <tbody id="official-prakompetisi-body">
                                ${initialOfficials.map((o, index) => renderOfficialPraKompetisiRow(o, index, canEdit)).join('')}
                            </tbody>
                        </table>
                        
                        ${canEdit ? `
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> Simpan Pendaftaran Official
                                </button>
                            </div>
                        ` : ''}
                    </form>
                </div>
            `;
        }

        function renderOfficialPraKompetisiRow(o, index, canEdit) {
            const officialOptions = COMBOBOX_OFFICIAL_LIST.map(official => {
                const isSelected = o.id_official === official.id_official;
                return `<option value="${official.id_official}" ${isSelected ? 'selected' : ''}>${official.nama_official} (${official.id_official})</option>`;
            }).join('');

            return `
                <tr id="official-row-${index}" class="border-b hover:bg-gray-50">
                    <td class="p-2">
                        ${canEdit ? `
                            <select id="official-select-${index}" class="w-full border rounded-md p-1 bg-white text-xs md:text-sm" onchange="updateOfficialDetails(${index}, this.value, 'official')">
                                <option value="">Pilih Official</option>
                                ${officialOptions}
                            </select>
                            <p class="text-xs text-gray-500 mt-1" id="official-info-${index}">${o.jabatan || '-'}</p>
                        ` : `
                            <p class="font-medium text-gray-800">${o.nama_official || '-'}</p>
                            <p class="text-xs text-gray-500">${o.id_official || '-'}</p>
                        `}
                    </td>
                    <td class="p-2 hidden sm:table-cell">
                        ${canEdit ? `<input type="text" id="official-jabatan-${index}" value="${o.jabatan || ''}" class="w-full border-none bg-transparent" readonly>` : (o.jabatan || '-')}
                    </td>
                    <td class="p-2 hidden md:table-cell">
                        ${canEdit ? `<input type="text" id="official-klub-${index}" value="${o.id_klub || ''}" class="w-full border-none bg-transparent" readonly>` : (o.id_klub || '-')}
                    </td>
                    ${canEdit ? `
                        <td class="p-2 text-center">
                            <button type="button" onclick="clearOfficialRow(${index})" class="p-1 text-red-600 hover:text-red-800">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    ` : ''}
                </tr>
            `;
        }
        
        // Logika Subform Pemain/Official
        function updatePlayerDetails(index, playerId) {
            const player = COMBOBOX_PLAYER_LIST.find(p => p.id_pemain === playerId) || {};
            
            document.getElementById(`player-info-${index}`).innerText = player.posisi || '-';
            
            // Isi hidden fields untuk memudahkan pengiriman data
            if (document.getElementById(`player-pos-${index}`)) document.getElementById(`player-pos-${index}`).value = player.posisi || '';
            if (document.getElementById(`player-klub-${index}`)) document.getElementById(`player-klub-${index}`).value = player.id_klub || '';
        }
        
        function clearPlayerRow(index) {
            document.getElementById(`player-select-${index}`).value = '';
            updatePlayerDetails(index, '');
        }

        function updateOfficialDetails(index, officialId) {
            const official = COMBOBOX_OFFICIAL_LIST.find(o => o.id_official === officialId) || {};
            
            document.getElementById(`official-info-${index}`).innerText = official.jabatan || '-';
            
            // Isi hidden fields untuk memudahkan pengiriman data
            if (document.getElementById(`official-jabatan-${index}`)) document.getElementById(`official-jabatan-${index}`).value = official.jabatan || '';
            if (document.getElementById(`official-klub-${index}`)) document.getElementById(`official-klub-${index}`).value = official.id_klub || '';
        }
        
        function clearOfficialRow(index) {
            document.getElementById(`official-select-${index}`).value = '';
            updateOfficialDetails(index, '');
        }

        async function handleSavePemainPraKompetisi(idKompetisi) {
            const confirmation = await showConfirmation('Anda yakin ingin menyimpan data pendaftaran pemain ini? Data lama akan diganti.');
            if (!confirmation) return;

            const maxPlayers = 25;
            const playersToSave = [];
            const selectedPlayerIds = new Set();
            let hasDuplicate = false;

            for (let i = 0; i < maxPlayers; i++) {
                const selectEl = document.getElementById(`player-select-${i}`);
                if (selectEl && selectEl.value) {
                    const playerId = selectEl.value;
                    const playerDetail = COMBOBOX_PLAYER_LIST.find(p => p.id_pemain === playerId);

                    if (selectedPlayerIds.has(playerId)) {
                        hasDuplicate = true;
                        break;
                    }
                    selectedPlayerIds.add(playerId);

                    if (playerDetail) {
                        playersToSave.push({
                            id_pemain: playerId,
                            nama_pemain: playerDetail.nama_pemain,
                            tanggal_lahir: playerDetail.tanggal_lahir,
                            nama_punggung: playerDetail.nama_punggung,
                            no_punggung: playerDetail.no_punggung,
                            posisi: playerDetail.posisi,
                            photo_pemain_url: playerDetail.photo_pemain_url,
                            id_klub: playerDetail.id_klub,
                            id_kompetisi: idKompetisi
                        });
                    }
                }
            }

            if (hasDuplicate) {
                showNotification('Tidak boleh ada ID Pemain ganda di daftar pendaftaran.', 'error');
                return;
            }

            const data = {
                id_kompetisi: idKompetisi,
                players: playersToSave
            };

            const result = await apiFetch('savePemainPrakompetisi', 'POST', data);

            if (result && result.status === 'success') {
                showNotification(result.message, 'success');
                // Reload subform
                await renderDetailKompetisi(idKompetisi);
            }
        }


        async function handleSaveOfficialPraKompetisi(idKompetisi) {
            const confirmation = await showConfirmation('Anda yakin ingin menyimpan data pendaftaran official ini? Data lama akan diganti.');
            if (!confirmation) return;

            const maxOfficials = 10;
            const officialsToSave = [];
            const selectedOfficialIds = new Set();
            let hasDuplicate = false;

            for (let i = 0; i < maxOfficials; i++) {
                const selectEl = document.getElementById(`official-select-${i}`);
                if (selectEl && selectEl.value) {
                    const officialId = selectEl.value;
                    const officialDetail = COMBOBOX_OFFICIAL_LIST.find(o => o.id_official === officialId);

                    if (selectedOfficialIds.has(officialId)) {
                        hasDuplicate = true;
                        break;
                    }
                    selectedOfficialIds.add(officialId);

                    if (officialDetail) {
                        officialsToSave.push({
                            id_official: officialId,
                            nama_official: officialDetail.nama_official,
                            tanggal_lahir: officialDetail.tanggal_lahir,
                            jabatan: officialDetail.jabatan,
                            photo_official_url: officialDetail.photo_official_url,
                            id_klub: officialDetail.id_klub,
                            id_kompetisi: idKompetisi
                        });
                    }
                }
            }

            if (hasDuplicate) {
                showNotification('Tidak boleh ada ID Official ganda di daftar pendaftaran.', 'error');
                return;
            }

            const data = {
                id_kompetisi: idKompetisi,
                officials: officialsToSave
            };

            const result = await apiFetch('saveOfficialPrakompetisi', 'POST', data);

            if (result && result.status === 'success') {
                showNotification(result.message, 'success');
                // Reload subform
                await renderDetailKompetisi(idKompetisi);
            }
        }


        // --- SETTING PAGE (Hanya ADMIN_PUSAT) ---

        async function renderSettingPage() {
            if (CURRENT_USER.type_users !== 'ADMIN_PUSAT') return renderAccessDenied();

            const result = await apiFetch('getSettingData', 'GET');
            SETTING_DATA = result.data || { banners: {}, userlist: [] };
            
            return `
                ${renderHeader('Pengaturan Sistem')}
                <div class="max-w-xl mx-auto p-4 space-y-6">
                    ${renderBannerSetting(SETTING_DATA.banners)}
                    ${renderUserlistSetting(SETTING_DATA.userlist)}
                </div>
            `;
        }

        function renderBannerSetting(banners) {
            return `
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h4 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Pengaturan Banner</h4>
                    <form id="banner-form" class="space-y-4" onsubmit="event.preventDefault(); handleSaveBanner();">
                        ${[1, 2, 3].map(i => `
                            <div class="space-y-2 border-b pb-3">
                                <label for="url_banner${i}_file" class="block text-sm font-medium text-gray-700">Banner ${i} URL</label>
                                <input type="file" id="url_banner${i}_file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                        onchange="document.getElementById('banner-preview-${i}').src = window.URL.createObjectURL(this.files[0] || '${banners[`url_banner${i}`] || 'https://placehold.co/100x30/A0AEC0/ffffff?text=Banner+Preview'}')">
                                <img id="banner-preview-${i}" src="${banners[`url_banner${i}`] || 'https://placehold.co/100x30/A0AEC0/ffffff?text=Banner+Preview'}" alt="Banner Preview ${i}" class="w-full h-24 object-cover rounded-lg">
                            </div>
                        `).join('')}
                        <button type="submit" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i> Simpan Banner
                        </button>
                    </form>
                </div>
            `;
        }

        async function handleSaveBanner() {
            const data = {};
            const keys = ["url_banner1", "url_banner2", "url_banner3"];

            for (const key of keys) {
                const fileInput = document.getElementById(`${key}_file`);
                if (fileInput.files[0]) {
                    try {
                        data[key] = await fileToBase64(fileInput.files[0]);
                    } catch (e) {
                        showNotification(`Gagal mengkonversi file ${key}.`, "error");
                        return;
                    }
                } else {
                    // Pertahankan URL lama
                    data[key] = SETTING_DATA.banners[key];
                }
            }

            const result = await apiFetch('updateBanner', 'POST', data);

            if (result && result.status === 'success') {
                showNotification('Pengaturan Banner berhasil diperbarui!', 'success');
                // Refresh data global dan halaman
                BANNER_DATA = result.data.data;
                await changePage('setting', true);
            }
        }


        function renderUserlistSetting(userlist) {
            const userTypeOptions = ['ADMIN_MEDIA', 'ADMIN_KLUB'].map(type => `<option value="${type}">${type}</option>`).join('');

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h4 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Pengaturan Pengguna (Non-Pusat)</h4>
                    <form id="userlist-form" onsubmit="event.preventDefault(); handleSaveUserlist();">
                        <div id="userlist-container" class="space-y-3">
                            ${userlist.map((u, index) => renderUserlistRow(u, index, userTypeOptions)).join('')}
                        </div>
                        
                        <button type="button" onclick="addUserlistRow()" class="mt-4 w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200 transition-colors">
                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i> Tambah Pengguna Baru
                        </button>

                        <button type="submit" class="mt-4 w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i> Simpan Daftar Pengguna
                        </button>
                    </form>
                </div>
            `;
        }

        let userlistRowCounter = 0;
        function renderUserlistRow(u = {}, index, userTypeOptions) {
            const uniqueId = index === undefined ? `new-${userlistRowCounter++}` : u.username;
            const isNew = index === undefined;
            const userTypeOptionsHtml = ['ADMIN_MEDIA', 'ADMIN_KLUB'].map(type => `<option value="${type}" ${u.type_users === type ? 'selected' : ''}>${type}</option>`).join('');

            return `
                <div id="user-row-${uniqueId}" class="p-3 border rounded-lg space-y-2 bg-gray-50">
                    <div class="flex justify-between items-center">
                        <h5 class="font-semibold text-gray-700">${isNew ? 'Pengguna Baru' : u.nama_admin || u.username}</h5>
                        <button type="button" onclick="removeUserlistRow('user-row-${uniqueId}')" class="p-1 text-red-600 hover:bg-red-100 rounded-full">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <input type="text" placeholder="Username" class="user-field w-full px-3 py-1 text-sm border rounded" data-field="username" value="${u.username || ''}" ${!isNew ? 'readonly' : 'required'}>
                    <input type="password" placeholder="Password" class="user-field w-full px-3 py-1 text-sm border rounded" data-field="password" value="${u.password || ''}" required>
                    <select class="user-field w-full px-3 py-1 text-sm border rounded" data-field="type_users" required>
                        <option value="">Pilih Tipe</option>
                        ${userTypeOptionsHtml}
                    </select>
                    <input type="text" placeholder="Nama Admin" class="user-field w-full px-3 py-1 text-sm border rounded" data-field="nama_admin" value="${u.nama_admin || ''}" required>
                    <input type="text" placeholder="ID Klub (cth: APM-001)" class="user-field w-full px-3 py-1 text-sm border rounded" data-field="id_klub" value="${u.id_klub || ''}" required>
                </div>
            `;
        }

        function addUserlistRow() {
            const container = document.getElementById('userlist-container');
            container.insertAdjacentHTML('beforeend', renderUserlistRow());
            lucide.createIcons();
        }

        function removeUserlistRow(id) {
            document.getElementById(id).remove();
        }

        async function handleSaveUserlist() {
            const container = document.getElementById('userlist-container');
            const userRows = container.querySelectorAll('[id^="user-row-"]');
            const dataToSave = [];

            // 1. Kumpulkan data
            for (const row of userRows) {
                const fields = row.querySelectorAll('.user-field');
                const user = {};
                fields.forEach(field => {
                    user[field.getAttribute('data-field')] = field.value;
                });

                if (!user.username || !user.password || !user.type_users || !user.nama_admin || !user.id_klub) {
                    showNotification('Semua field pengguna harus diisi.', 'error');
                    return;
                }
                dataToSave.push(user);
            }

            // 2. Cek duplikat username (hanya di frontend)
            const usernames = dataToSave.map(u => u.username);
            const uniqueUsernames = new Set(usernames);
            if (usernames.length !== uniqueUsernames.size) {
                showNotification('Terdapat username ganda di daftar pengguna.', 'error');
                return;
            }

            // 3. Kirim ke API
            const result = await apiFetch('updateUserList', 'POST', dataToSave);

            if (result && result.status === 'success') {
                showNotification('Daftar pengguna berhasil diperbarui!', 'success');
                await changePage('setting', true);
            }
        }

        // --- COMMON UTILITY ---

        /**
         * Menutup modal.
         * @param {string} id ID modal.
         */
        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('show');
        }

        /**
         * Template container untuk modal (posisi sepertiga atas tengah).
         * @param {string} id ID modal.
         */
        function renderModalContainer(id) {
            return `<div id="${id}" class="modal-overlay" style="align-items: flex-start; top: 33.33vh; height: auto;"></div>`;
        }
        
        /**
         * Halaman Akses Ditolak.
         */
        function renderAccessDenied() {
            return `
                ${renderHeader('Akses Ditolak')}
                <div class="max-w-xl mx-auto p-8 text-center bg-white rounded-xl shadow-lg mt-8">
                    <i data-lucide="lock" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800">Akses Ditolak</h3>
                    <p class="mt-2 text-gray-600">Anda tidak memiliki izin untuk mengakses halaman ini.</p>
                </div>
            `;
        }

        // *** START APP ***
        document.addEventListener('DOMContentLoaded', checkSessionStatus);
    </script>
</body>
</html>
